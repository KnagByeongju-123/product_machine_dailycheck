<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>설비점검체크시트</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 0; margin: 0;
      background: #f5f5f5;
      font-size: 20.28px;
    }
    .container {
      width: 100%; max-width: 360px;
      margin: 0 auto; padding: 16px;
      box-sizing: border-box;
    }
    input[type="text"], input[type="date"], select, textarea {
      width: 100%; box-sizing: border-box;
      padding: 16px; margin: 0 0 20px;
      font-size: 20.28px;
    }
    textarea { resize: vertical; height: 80px; }
    textarea::placeholder { font-size: 13.2px; color: #aaa; }
    button, input[type="submit"] {
      width: 100%; padding: 20px;
      font-size: 20.28px; border: none;
      border-radius: 6px; background: #333;
      color: #fff; cursor: pointer;
      margin-bottom: 20px;
    }
    label {
      font-size: 20.28px;
      display: block; margin-bottom: 8px;
    }
  </style>
  <!-- QR카메라 스타일 및 컬러 매핑 -->
  <style>
    body {
      font-family: Arial, sans-serif;
      font-size: 18px;
      padding: 20px;
      max-width: 600px;
      margin: auto;
      background-color: #f9f9f9;
    }
    label {
      display: block;
      margin-top: 14px;
      font-weight: bold;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      box-sizing: border-box;
      font-size: 16px;
    }
    button[type="button"] {
      margin-bottom: 20px;
    }
    #preview-wrapper {
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #preview-wrapper > div { position: relative; }
    #preview { width: 300px; height: 300px; background: #fff; }
    #closePreview {
      position: absolute;
      top: -45px;
      left: 0;
      padding: 8px 12px;
      background-color: red;
      color: white;
      border: none;
      font-size: 14px;
      cursor: pointer;
      z-index: 10000;
    }
    /* QR 버튼 기본 스타일 */
    .qr-btn {
      width: 100%;
      padding: 10px;
      box-sizing: border-box;
      font-size: 16px;
      border-radius: 6px;
      color: white;
      border: none;
      cursor: pointer;
      margin: 0 0 20px;
    }
    .btn-item1 { background-color: #fb8c00 }
    .btn-item4 { background-color: #8e24aa; }
    .btn-item5 { background-color: #3949ab; }
    .btn-item6 { background-color: #00897b; }
    .btn-item7 { background-color: #fdd835; color: #000; }
    .btn-item8 { background-color: #fb8c00; }
    /* 라벨 텍스트 색상 매핑 */
    .label-item1-3 { color: #fb8c00; }
    .label-item4   { color: #8e24aa; }
    .label-item5   { color: #3949ab; }
    .label-item6   { color: #00897b; }
    .label-item7   { color: #fdd835; }
    .label-item8   { color: #fb8c00; }
  </style>
</head>
<body>
  <div class="container">
    <h2 style="text-align:center; margin-bottom:16px;">설비점검 체크시트</h2>
    <form id="checkForm">
      <!-- 1. 점검일자 -->
      <label for="date">점검일자</label>
      <input type="date" id="date" name="일자" required />

      <!-- 2. 점검자 -->
      <label for="inspector">점검자</label>
      <input type="text" id="inspector" name="점검자" placeholder="이름 입력" required />

      <!-- 3. 호기 (하드코딩) -->
      <label for="equipmentInput">호기</label>
      <select id="equipmentInput" name="호기" required>
        <option value="">호기를 선택하세요</option>
        <option value="1호기 쌍용200톤">1호기 쌍용200톤</option>
        <option value="2호기 심팩200톤">2호기 심팩200톤</option>
        <option value="3호기 심팩150톤">3호기 심팩150톤</option>
        <option value="4호기 심팩150톤">4호기 심팩150톤</option>
        <option value="5호기 심팩110톤">5호기 심팩110톤</option>
        <option value="6호기 심팩110톤">6호기 심팩110톤</option>
        <option value="28호기 국일200톤">28호기 국일200톤</option>
        <option value="29호기 국일200톤">29호기 국일200톤</option>
        <option value="30호기 국일160톤">30호기 국일160톤</option>
        <option value="31호기 심팩150톤">31호기 심팩150톤</option>
        <option value="32호기 심팩200톤">32호기 심팩200톤</option>
        <option value="33호기 심팩250톤">33호기 심팩250톤</option>
        <option value="34호기 심팩250톤">34호기 심팩250톤</option>
        <option value="35호기 심팩250톤">35호기 심팩250톤</option>
        <option value="36호기 심팩300톤">36호기 심팩300톤</option>
        <option value="37호기 국일200톤">37호기 국일200톤</option>
        <option value="38호기 국일200톤">38호기 국일200톤</option>
        <option value="39호기 국일200톤">39호기 국일200톤</option>
        <option value="40호기 심팩200톤">40호기 심팩200톤</option>
        <option value="41호기 국일200톤">41호기 국일200톤</option>
        <option value="43호기 화일800톤">43호기 화일800톤</option>
        <option value="45호기 심팩300톤">45호기 심팩300톤</option>
        <option value="46호기 심팩300톤">46호기 심팩300톤</option>
        <option value="47호기 심팩300톤">47호기 심팩300톤</option>
        <option value="48호기 심팩300톤">48호기 심팩300톤</option>
        <option value="49호기 심팩300톤">49호기 심팩300톤</option>
      </select>

      <!-- 이하 점검항목 -->
      <label class="label-item1-3">1. 오버로드 프로텍트 (정상범위)</label>
      <select id="select-항목1" name="오버로드 프로텍트 (정상범위)" disabled>
        <option value="">선택</option><option value="OK">OK</option><option value="NG">NG</option>
      </select>
      <button type="button" class="qr-btn btn-item1" onclick="scanQRCode('항목1')">QR 코드 스캔</button>

      <label class="label-item1-3">2. 발란스 실린더 (정상범위)</label>
      <select id="select-항목2" name="발란스 실린더 (정상범위)" disabled>
        <option value="">선택</option><option value="OK">OK</option><option value="NG">NG</option>
      </select>

      <label class="label-item1-3">3. 클러치 브레이크 (정상범위)</label>
      <select id="select-항목3" name="클러치 브레이크 (정상범위)" disabled>
        <option value="">선택</option><option value="OK">OK</option><option value="NG">NG</option>
      </select>

      <label class="label-item4">4. 모터 (이상음)</label>
      <select id="select-항목4" name="모터 (이상음)" disabled>
        <option value="">선택</option><option value="OK">OK</option><option value="NG">NG</option>
      </select>
      <button type="button" class="qr-btn btn-item4" onclick="scanQRCode('항목4')">QR 코드 스캔</button>

      <label class="label-item5">5. 클러치 (작동상태)</label>
      <select id="select-항목5" name="클러치 (작동상태)" disabled>
        <option value="">선택</option><option value="OK">OK</option><option value="NG">NG</option>
      </select>
      <button type="button" class="qr-btn btn-item5" onclick="scanQRCode('항목5')">QR 코드 스캔</button>

      <label class="label-item6">6. 안전장치 (센서,양수조작버튼)</label>
      <select id="select-항목6" name="안전장치 (센서,양수조작버튼)" disabled>
        <option value="">선택</option><option value="OK">OK</option><option value="NG">NG</option>
      </select>
      <button type="button" class="qr-btn btn-item6" onclick="scanQRCode('항목6')">QR 코드 스캔</button>

      <label class="label-item7">7. 오일러의 급유 (적정량, 흐름상태)</label>
      <select id="select-항목7" name="오일러의 급유 (적정량, 흐름상태)" disabled>
        <option value="">선택</option><option value="OK">OK</option><option value="NG">NG</option>
      </select>
      <button type="button" class="qr-btn btn-item7" onclick="scanQRCode('항목7')">QR 코드 스캔</button>

      <label class="label-item8">8. 피치세팅장치 (공급상태)</label>
      <select id="select-항목8" name="피치세팅장치 (공급상태)" disabled>
        <option value="">선택</option><option value="OK">OK</option><option value="NG">NG</option>
      </select>
      <button type="button" class="qr-btn btn-item8" onclick="scanQRCode('항목8')">QR 코드 스캔</button>

      <label>9. 안전보호구 착용(크레인 및 사다리사용 → 안전모착용)</label>
      <select id="select-항목9" name="크레인,사다리등 사용시 안전모착용">
        <option value="">선택</option><option value="OK">OK</option><option value="NG">NG</option>
      </select>

      <label for="comment">비고</label>
      <textarea id="comment" name="비고" placeholder="비고를 입력하세요"></textarea>

      <input type="submit" value="제출 (1회 클릭후 대기)" />
    </form>
  </div>

  <!-- QR 스캐너 미리보기 -->
  <div id="preview-wrapper">
    <div>
      <button id="closePreview">닫기</button>
      <div id="preview"></div>
    </div>
  </div>

  <script>
    // 페이지 로드 시 오늘 날짜 자동 세팅
    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('date').value = new Date().toISOString().slice(0,10);
    });

    // QR 스캔 및 정지 함수
    let html5QrCodeInstance = null;

    function scanQRCode(targetId) {
      const wrapper = document.getElementById("preview-wrapper");
      const preview = document.getElementById("preview");
      preview.innerHTML = "";
      wrapper.style.display = "flex";

      if (html5QrCodeInstance) {
        html5QrCodeInstance.stop().catch(()=>{});
        html5QrCodeInstance.clear().catch(()=>{});
        html5QrCodeInstance = null;
      }

      html5QrCodeInstance = new Html5Qrcode("preview");
      html5QrCodeInstance.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 280, height: 280 } },
        decodedText => {
      
          const 항목번호 = targetId.replace("항목", "");
      

          if (decodedText === expected) {
            const sel = document.getElementById(`select-${targetId}`);
            sel.disabled = false;
            sel.value = 'OK';
            if (targetId === "항목1") {
              const sel2 = document.getElementById("select-항목2");
              const sel3 = document.getElementById("select-항목3");
              sel2.disabled = false; sel2.value = 'OK';
              sel3.disabled = false; sel3.value = 'OK';
            }
            alert(`QR코드 일치: ${decodedText}`);
          } else {
            alert(`불일치\n읽음: ${decodedText}\n기대: ${expected}`);
          }
          stopQrScanner();
        },
        err => console.warn("QR 인식 실패:", err)
      ).catch(err => {
        alert("카메라 초기화 실패: 권한 확인 또는 다른 앱 사용 중인지 확인하세요.");
        console.error(err);
        wrapper.style.display = "none";
      });
    }

    function stopQrScanner() {
      const wrapper = document.getElementById("preview-wrapper");
      wrapper.style.display = "none";
      if (html5QrCodeInstance) {
        html5QrCodeInstance.stop()
          .then(() => html5QrCodeInstance.clear())
          .then(() => { html5QrCodeInstance = null; })
          .catch(console.error);
      }
    }

    document.getElementById("closePreview").addEventListener("click", stopQrScanner);

    // 폼 제출 처리 (Apps Script Web App)
    document.getElementById('checkForm')
      .addEventListener('submit', function(e) {
        e.preventDefault();
        const body = new URLSearchParams(new FormData(this));
        fetch('https://script.google.com/macros/s/AKfycbyUxDs7OSA89FVyOKip3bK7p8zSMSPGCjlUqM7KlmOK-aY5LrtO7mJNGJ3eNQyxHUwIVg/exec', {
          method:'POST', body
        })
        .then(r=>r.text())
        .then(_=>{ alert('제출 완료'); this.reset(); })
        .catch(err=>alert('제출 실패: '+err));
      });
  </script>
</body>
</html>
