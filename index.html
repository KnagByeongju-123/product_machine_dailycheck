<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>설비점검체크시트</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 0; margin: 0;
      background: #f5f5f5;
      font-size: 20.28px;
    }
    .container {
      width: 100%; max-width: 360px;
      margin: 0 auto; padding: 16px;
      box-sizing: border-box;
    }
    input[type="text"], input[type="date"], select, textarea {
      width: 100%; box-sizing: border-box;
      padding: 16px; margin: 0 0 20px;
      font-size: 20.28px;
    }
    textarea { resize: vertical; height: 80px; }
    textarea::placeholder { font-size: 13.2px; color: #aaa; }
    button, input[type="submit"] {
      width: 100%; padding: 20px;
      font-size: 20.28px; border: none;
      border-radius: 6px; background: #333;
      color: #fff; cursor: pointer;
      margin-bottom: 20px;
    }
    label {
      font-size: 20.28px;
      display: block; margin-bottom: 8px;
    }
  </style>
  <!-- QR카메라 스타일 (html_QR소스_닫기버튼.txt 기준) -->
  <style>
    body {
      font-family: Arial, sans-serif;
      font-size: 18px;
      padding: 20px;
      max-width: 600px;
      margin: auto;
      background-color: #f9f9f9;
    }
    label {
      display: block;
      margin-top: 14px;
      font-weight: bold;
    }
    input, select, textarea, button {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      box-sizing: border-box;
      font-size: 16px;
    }
    button {
      background-color: #1976d2;
      color: white;
      border: none;
      cursor: pointer;
    }
    #preview-wrapper {
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #preview-wrapper > div { position: relative; }
    #preview { width: 300px; height: 300px; background: #fff; }
    #closePreview {
      position: absolute;
      top: -45px;
      left: 0;
      padding: 8px 12px;
      background-color: red;
      color: white;
      border: none;
      font-size: 14px;
      cursor: pointer;
      z-index: 10000;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2 style="text-align:center; margin-bottom:16px;">설비점검 체크시트</h2>
    <form id="checkForm">
      <!-- 1. 점검일자 -->
      <label for="date">점검일자</label>
      <input type="date" id="date" name="일자" required />

      <!-- 2. 점검자 -->
      <label for="inspector">점검자</label>
      <input type="text" id="inspector" name="점검자" placeholder="이름 입력" required />

      <!-- 3. 호기 (하드코딩) -->
      <label for="equipmentInput">호기</label>
      <select id="equipmentInput" name="호기" required>
        <option value="">호기를 선택하세요</option>
        <option value="1호기">1호기 쌍용200톤</option>
        <option value="2호기">2호기 심팩200톤</option>
        <option value="3호기">3호기 심팩150톤</option>
        <option value="4호기">4호기 심팩150톤</option>
        <option value="5호기">5호기 심팩110톤</option>
        <option value="6호기">6호기 심팩110톤</option>
        <option value="28호기">28호기 국일200톤</option>
        <option value="29호기">29호기 국일200톤</option>
        <option value="30호기">30호기 국일160톤</option>
        <option value="31호기">31호기 심팩150톤</option>
        <option value="32호기">32호기 심팩200톤</option>
        <option value="33호기">33호기 심팩250톤</option>
        <option value="34호기">34호기 심팩250톤</option>
        <option value="35호기">35호기 심팩250톤</option>
        <option value="36호기">36호기 심팩300톤</option>
        <option value="37호기">37호기 국일200톤</option>
        <option value="38호기">38호기 국일200톤</option>
        <option value="39호기">39호기 국일200톤</option>
        <option value="40호기">40호기 심팩200톤</option>
        <option value="41호기">41호기 국일200톤</option>
        <option value="43호기">43호기 화일800톤</option>
        <option value="45호기">45호기 심팩300톤</option>
        <option value="46호기">46호기 심팩300톤</option>
        <option value="47호기">47호기 심팩300톤</option>
        <option value="48호기">48호기 심팩300톤</option>
        <option value="49호기">49호기 심팩300톤</option>
      </select>

      <!-- 이하 점검항목 -->
      <label>오버로드 프로텍트 (정상범위)</label>
      <select id="select-항목1" name="오버로드 프로텍트 (정상범위)" disabled>
        <option value="">선택</option><option value="OK">OK</option><option value="NG">NG</option>
      </select>
      <button type="button" onclick="scanQRCode('항목1')">QR 코드 스캔</button>

      <label>발란스 실린더 (정상범위)</label>
      <select id="select-항목2" name="발란스 실린더 (정상범위)" disabled>
        <option value="">선택</option><option value="OK">OK</option><option value="NG">NG</option>
      </select>
      <!-- QR 스캔 버튼 삭제 -->

      <label>클러치 브레이크 (정상범위)</label>
      <select id="select-항목3" name="클러치 브레이크 (정상범위)" disabled>
        <option value="">선택</option><option value="OK">OK</option><option value="NG">NG</option>
      </select>
      <!-- QR 스캔 버튼 삭제 -->

      <label>모터 (이상음)</label>
      <select id="select-항목4" name="모터 (이상음)" disabled>
        <option value="">선택</option><option value="OK">OK</option><option value="NG">NG</option>
      </select>
      <button type="button" onclick="scanQRCode('항목4')">QR 코드 스캔</button>

      <label>클러치 (작동상태)</label>
      <select id="select-항목5" name="클러치 (작동상태)" disabled>
        <option value="">선택</option><option value="OK">OK</option><option value="NG">NG</option>
      </select>
      <button type="button" onclick="scanQRCode('항목5')">QR 코드 스캔</button>

      <label>안전장치 (센서,양수조작버튼)</label>
      <select id="select-항목6" name="안전장치 (센서,양수조작버튼)" disabled>
        <option value="">선택</option><option value="OK">OK</option><option value="NG">NG</option>
      </select>
      <button type="button" onclick="scanQRCode('항목6')">QR 코드 스캔</button>

      <label>오일러의 급유 (적정량, 흐름상태)</label>
      <select id="select-항목7" name="오일러의 급유 (적정량, 흐름상태)" disabled>
        <option value="">선택</option><option value="OK">OK</option><option value="NG">NG</option>
      </select>
      <button type="button" onclick="scanQRCode('항목7')">QR 코드 스캔</button>

      <label>피치세팅장치 (공급상태)</label>
      <select id="select-항목8" name="피치세팅장치 (공급상태)" disabled>
        <option value="">선택</option><option value="OK">OK</option><option value="NG">NG</option>
      </select>
      <button type="button" onclick="scanQRCode('항목8')">QR 코드 스캔</button>

      <label>크레인,사다리등 사용시 안전모착용</label>
      <select id="select-항목9" name="크레인,사다리등 사용시 안전모착용">
        <option value="">선택</option><option value="OK">OK</option><option value="NG">NG</option>
      </select>

      <label for="comment">비고</label>
      <textarea id="comment" name="비고" placeholder="비고를 입력하세요"></textarea>

      <input type="submit" value="제출" />
    </form>
  </div>

  <!-- QR 스캐너 미리보기 (html_QR소스_닫기버튼.txt 기준) -->
  <div id="preview-wrapper">
    <div>
      <button id="closePreview">닫기</button>
      <div id="preview"></div>
    </div>
  </div>

  <script>
    // 페이지 로드 시 오늘 날짜 자동 세팅
    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('date').value = new Date().toISOString().slice(0,10);
    });

    // QR 스캔 및 정지 함수 (html_QR소스_닫기버튼.txt 기준)
    let html5QrCodeInstance = null;

    function scanQRCode(targetId) {
      const wrapper = document.getElementById("preview-wrapper");
      const preview = document.getElementById("preview");
      preview.innerHTML = "";
      wrapper.style.display = "flex";

      if (html5QrCodeInstance) {
        html5QrCodeInstance.stop().catch(()=>{});
        html5QrCodeInstance.clear().catch(()=>{});
        html5QrCodeInstance = null;
      }

      html5QrCodeInstance = new Html5Qrcode("preview");
      html5QrCodeInstance.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 280, height: 280 } },
decodedText => {
  // 1) 설비번호 가져오기
  const 설비번호 = document.getElementById("equipmentInput").value.trim();
  // 2) 타겟 항목 번호만 추출 (예: '항목4' → '4')
  const 항목번호 = targetId.replace("항목", "");
  // 3) 기대 QR 문자열
  const expected = `${설비번호}-${항목번호}`;

  if (decodedText === expected) {
    // 일치하면 select 활성화
    document.getElementById(`select-${targetId}`).disabled = false;
    alert(`QR코드 일치: ${decodedText}`);
  } else {
    alert(`불일치\n읽음: ${decodedText}\n기대: ${expected}`);
  }

  stopQrScanner();
},
        err => console.warn("QR 인식 실패:", err)
      ).catch(err => {
        alert("카메라 초기화 실패: 권한 확인 또는 다른 앱 사용 중인지 확인하세요.");
        console.error(err);
        wrapper.style.display = "none";
      });
    }

    function stopQrScanner() {
      const wrapper = document.getElementById("preview-wrapper");
      wrapper.style.display = "none";
      if (html5QrCodeInstance) {
        html5QrCodeInstance.stop()
          .then(() => html5QrCodeInstance.clear())
          .then(() => { html5QrCodeInstance = null; })
          .catch(console.error);
      }
    }

    document.getElementById("closePreview").addEventListener("click", stopQrScanner);

    // 폼 제출 처리 (Apps Script Web App)
    document.getElementById('checkForm')
      .addEventListener('submit', function(e) {
        e.preventDefault();
        const body = new URLSearchParams(new FormData(this));
        fetch('https://script.google.com/macros/s/AKfycbzCPVPnQOuK9ocCvnHwKrIbAhC_tb_hxkaE_GibM51jnRXmX2509jBPZE-Ydz0flw5Y/exec', {
          method:'POST', body
        })
        .then(r=>r.text())
        .then(_=>{ alert('제출 완료'); this.reset(); })
        .catch(err=>alert('제출 실패: '+err));
      });
  </script>
</body>
</html>
